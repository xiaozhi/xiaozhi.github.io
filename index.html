<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="CJZ's Blog" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="CJZ&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="CJZ&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CJZ&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>CJZ's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CJZ's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">回忆昨天，珍惜今天，期待明天</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/20/monitor-main-thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/20/monitor-main-thread/" itemprop="url">卡顿监控笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-20T18:57:23+08:00">
                2020-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>卡顿监控就目前来说有三种方案：</p>
<h3 id="CADisplayLink-计算帧数"><a href="#CADisplayLink-计算帧数" class="headerlink" title="CADisplayLink 计算帧数"></a>CADisplayLink 计算帧数</h3><p><code>CADisplayLink</code>是和屏幕刷新保持同步的，所以可以用这个来展示<code>fps</code>的值。</p>
<p>这种方案有个问题，就是帧率变化也会被当成卡顿。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UILabel</span> *_fpsLbe;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CADisplayLink</span> *_link;</span><br><span class="line">    <span class="built_in">NSTimeInterval</span> _lastTime;</span><br><span class="line">    <span class="keyword">float</span> _fps;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)startMonitoring &#123;</span><br><span class="line">    <span class="keyword">if</span> (_link) &#123;</span><br><span class="line">        [_link removeFromRunLoop:[<span class="built_in">NSRunLoop</span> mainRunLoop] forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">        [_link invalidate];</span><br><span class="line">        _link = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _link = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(fpsDisplayLinkAction:)];</span><br><span class="line">    [_link addToRunLoop:[<span class="built_in">NSRunLoop</span> mainRunLoop] forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fpsDisplayLinkAction:(<span class="built_in">CADisplayLink</span> *)link &#123;</span><br><span class="line">    <span class="keyword">if</span> (_lastTime == <span class="number">0</span>) &#123;</span><br><span class="line">        _lastTime = link.timestamp;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.count++;</span><br><span class="line">    <span class="built_in">NSTimeInterval</span> delta = link.timestamp - _lastTime;</span><br><span class="line">    <span class="keyword">if</span> (delta &lt; <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">    _lastTime = link.timestamp;</span><br><span class="line">    _fps = _count / delta;</span><br><span class="line">    <span class="keyword">self</span>.count = <span class="number">0</span>;</span><br><span class="line">    _fpsLbe.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"FPS:%.0f"</span>,_fps];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用Runloop的状态来判断是否出现卡顿"><a href="#使用Runloop的状态来判断是否出现卡顿" class="headerlink" title="使用Runloop的状态来判断是否出现卡顿"></a>使用Runloop的状态来判断是否出现卡顿</h3><p>所有的代码运行都是基于<code>Runloop</code>的，我们就可以通过监听 <code>Runloop</code>的状态，来判断调用方法是否执行时间是否过长。</p>
<p>参考网上的<code>Runloop</code>精简的代码<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/// 1. 通知Observers，即将进入RunLoop</span></span><br><span class="line">    <span class="comment">/// 此处有Observer会创建AutoreleasePool: _objc_autoreleasePoolPush();</span></span><br><span class="line">    <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopEntry);</span><br><span class="line">    <span class="selector-tag">do</span> &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/// 2. 通知 Observers: 即将触发 Timer 回调。</span></span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopBeforeTimers);</span><br><span class="line">        <span class="comment">/// 3. 通知 Observers: 即将触发 Source (非基于port的,Source0) 回调。</span></span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopBeforeSources);</span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__</span>(block);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/// 4. 触发 Source0 (非基于port的) 回调。</span></span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</span>(source0);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// 5. GCD处理main block</span></span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__</span>(block);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/// 6. 通知Observers，即将进入休眠</span></span><br><span class="line">        <span class="comment">/// 此处有Observer释放并新建AutoreleasePool: _objc_autoreleasePoolPop(); _objc_autoreleasePoolPush();</span></span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopBeforeWaiting);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/// 7. sleep to wait msg.</span></span><br><span class="line">        <span class="selector-tag">mach_msg</span>() <span class="selector-tag">-</span>&gt; <span class="selector-tag">mach_msg_trap</span>();</span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line">        <span class="comment">/// 8. 通知Observers，线程被唤醒</span></span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopAfterWaiting);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/// 9. 如果是被Timer唤醒的，回调Timer</span></span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__</span>(timer);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/// 9. 如果是被dispatch唤醒的，执行所有调用 dispatch_async 等方法放入main queue 的 block</span></span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</span>(dispatched_block);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/// 9. 如果如果Runloop是被 Source1 (基于port的) 的事件唤醒了，处理这个事件</span></span><br><span class="line">        <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__</span>(source1);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    &#125; <span class="selector-tag">while</span> (...);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/// 10. 通知Observers，即将退出RunLoop</span></span><br><span class="line">    <span class="comment">/// 此处有Observer释放AutoreleasePool: _objc_autoreleasePoolPop();</span></span><br><span class="line">    <span class="selector-tag">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>(kCFRunLoopExit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们会向<code>Runloop</code>添加一个<code>Observer</code>，然后在回调的方法时，把状态记录下来。如果在<code>kCFRunLoopBeforeSources</code>或者在<code>kCFRunLoopAfterWaiting</code>这两个状态保持时间太长，我们就可以认为线程受阻了。</p>
<p>举个例子<br>这个<code>buttonTap</code>里面操作非常耗时，<code>buttonTap</code>这个函数<code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</code>是在<code>runloop</code>这个方法调用到的。在这个时间，我们保存的状态应该是<code>kCFRunLoopBeforeSources</code>，如果一直长时间在这个状态，就可以认为当时线程受阻。<br><img src="http://note.youdao.com/yws/res/10923/E410821CFC034FA98D7A02C757EFF6D5" alt="image"></p>
<p>参考戴铭老师的代码如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MonitorMain</span>()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) dispatch_semaphore_t dispatchSemaphore;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CFRunLoopObserverRef</span> runLoopObserver;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> timeoutCount;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CFRunLoopActivity</span> runLoopActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MonitorMain</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)start &#123;</span><br><span class="line">    <span class="keyword">self</span>.dispatchSemaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//        dispatchSemaphore = dispatch_semaphore_create(0);</span></span><br><span class="line">    <span class="built_in">CFRunLoopObserverContext</span> context = &#123;<span class="number">0</span>, (__bridge <span class="keyword">void</span> *)<span class="keyword">self</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="keyword">self</span>.runLoopObserver = <span class="built_in">CFRunLoopObserverCreate</span>(kCFAllocatorDefault,</span><br><span class="line">                                                   kCFRunLoopAllActivities,</span><br><span class="line">                                                   <span class="literal">YES</span>,</span><br><span class="line">                                                   <span class="number">0</span>,</span><br><span class="line">                                                   &amp;runLoopCallBack,</span><br><span class="line">                                                   &amp;context);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetMain</span>(), <span class="keyword">self</span>.runLoopObserver, kCFRunLoopCommonModes);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">YES</span>) &#123;</span><br><span class="line">            <span class="comment">// 88 ms后，就会超时。连续三次超时，记启动一次的记录一次卡顿</span></span><br><span class="line">            <span class="keyword">long</span> semaphoreWait = dispatch_semaphore_wait(<span class="keyword">self</span>-&gt;_dispatchSemaphore, dispatch_time(DISPATCH_TIME_NOW, <span class="number">88</span> * <span class="built_in">NSEC_PER_MSEC</span>));</span><br><span class="line">            <span class="comment">// 如果是超时了，这里不等于0</span></span><br><span class="line">            <span class="keyword">if</span> (semaphoreWait != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// stop</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">self</span>.runLoopObserver) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.timeoutCount = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">self</span>.dispatchSemaphore = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">self</span>.runLoopActivity = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.runLoopActivity == kCFRunLoopBeforeSources ||</span><br><span class="line">                    <span class="keyword">self</span>.runLoopActivity == kCFRunLoopAfterWaiting) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.timeoutCount ++ ;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">self</span>.timeoutCount &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@"检测到卡顿"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">self</span>.timeoutCount = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> runLoopCallBack(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity, <span class="keyword">void</span> *info) &#123;</span><br><span class="line">    MonitorMain *monitor = (__bridge MonitorMain*)info;</span><br><span class="line">    monitor.runLoopActivity = activity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (activity) &#123;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopEntry:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"kCFRunLoopEntry"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopBeforeTimers:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"kCFRunLoopBeforeTimers"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopBeforeSources:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"kCFRunLoopBeforeSources"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopBeforeWaiting:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"kCFRunLoopBeforeWaiting"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopAfterWaiting:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"kCFRunLoopAfterWaiting"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopExit:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"kCFRunLoopExit"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopAllActivities:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"kCFRunLoopAllActivities"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发出信号</span></span><br><span class="line">    dispatch_semaphore_signal(monitor.dispatchSemaphore);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)stop &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.runLoopObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CFRunLoopRemoveObserver</span>(<span class="built_in">CFRunLoopGetMain</span>(), <span class="keyword">self</span>.runLoopObserver, kCFRunLoopCommonModes);</span><br><span class="line">    <span class="built_in">CFRelease</span>(<span class="keyword">self</span>.runLoopObserver);</span><br><span class="line">    <span class="keyword">self</span>.runLoopObserver = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>但是这个方法有个问题暂时还没找到答案：</p>
<p><img src="http://note.youdao.com/yws/res/11039/C6A81FF715134A27A7BF070BABBC4CAA" alt="image"></p>
<p>从上图可以看到<code>- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath</code>方法是回调在<code>- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath</code>里面。</p>
<p>而这时是走到了<code>kCFRunLoopBeforeWaiting</code>这个状态里，所以卡顿的状态判断是没办法判断这种情况的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/20/binary-rebing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/20/binary-rebing/" itemprop="url">二进制重排笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-20T18:48:08+08:00">
                2020-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在文章开始之前，先搞明白一个问题，在iOS为什么二进制重排能优化启动时间？</p>
<blockquote>
<p>一句话来说，就是减少 Page Fault 带来的性能损失</p>
</blockquote>
<p>那么什么是<code>PageFault</code>，我们先从虚拟内存讲起。</p>
<h2 id="为什么会引入虚拟内存"><a href="#为什么会引入虚拟内存" class="headerlink" title="为什么会引入虚拟内存"></a>为什么会引入虚拟内存</h2><ul>
<li>地址空间不隔离,所有程序都可以直接访问物理地址，恶意程序就可以随便修改内存的的值。</li>
<li>内存使用效率低<ul>
<li>当A和B读进内存中，忽然要执行c，这时候内存不够，而C差不多要占据整个内存，就要把A和B存回磁盘中。因为这样子大量的数据换出换入，效率低下。</li>
</ul>
</li>
<li>程序运行的地址不确定<br>因为在程序编写中，指令和数据的地址是固定的，这样子就涉及了程序的重定位问题。</li>
</ul>
<p>正是因为上面的3大问题，所以在计算机中引入了虚拟地址的概念。</p>
<h3 id="分段"><a href="#分段" class="headerlink" title="分段"></a>分段</h3><p>一开始的方案是使用分段，即把每个程序的对应的虚拟内存地址映身到物理内存中<br><img src="http://note.youdao.com/yws/res/11177/3117C23F84624A008B916EA562ADF24D" alt="image"><br>像这种，虽然能解决地址隔离和重定位的问题，但是效率还是不高，因为每次都要把整块地址交换到磁盘中。</p>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><p>分页的基本方法是地址空间人为地等分成固定大小的页，每一页的大小由硬件决定,由操作系统选择决定页的大小。<br><img src="http://note.youdao.com/yws/res/11184/F79DCA589FB54681844E6E6D433511E8" alt="image"><br>如上图所谓，内存映射表会把每一页虚拟内存映射到 物理内存 中。<br>如果进程1要访问 Virtual Page 3，这时 page3 不在内存中，就会发生缺页中断，就是 页错误（Page Fault，缺页异常)。然后操作系统接管进程，负现把 Page 3从磁盘中读出来装到内存中。然后内存映射表建立映射关系。</p>
<p>虚拟内存的实现要依靠硬件的实现，一般来说CPU内置着一个叫 MMU (Memory Management Unit)的部件进行页映射。</p>
<p><img src="http://note.youdao.com/yws/res/11182/541C065B8EAB469E8601F9B82ED50408" alt="image"></p>
<h2 id="怎么做"><a href="#怎么做" class="headerlink" title="怎么做"></a>怎么做</h2><ol>
<li>生成Order文件</li>
<li>在<code>Xcode</code> 的 <code>BuildSetting</code>里配置Order文件</li>
<li>生成LinkMap文件，查看是否重排成功</li>
<li>使用System Trace查看<code>page fault</code>的次数</li>
<li>最终要看启动时间是否减少</li>
</ol>
<p>其中的难点就在于怎么生成 <code>Oder</code> 文件，把 App 启动时的调用到的符号尽可能放在一个page里</p>
<h3 id="生成Order的三种方法"><a href="#生成Order的三种方法" class="headerlink" title="生成Order的三种方法"></a>生成Order的三种方法</h3><h3 id="clang-静态插桩"><a href="#clang-静态插桩" class="headerlink" title="clang 静态插桩"></a>clang 静态插桩</h3><p>静态插桩就是利用clang提供的回调方法，在回调方法里面获取符号。</p>
<p>官方文档：<a href="https://clang.llvm.org/docs/SanitizerCoverage.html#tracing-pcs" target="_blank" rel="noopener">https://clang.llvm.org/docs/SanitizerCoverage.html#tracing-pcs</a></p>
<p>大佬提供的库: <a href="https://github.com/yulingtianxia/AppOrderFiles" target="_blank" rel="noopener">https://github.com/yulingtianxia/AppOrderFiles</a></p>
<h3 id="使用fishhook-objc-msgSend-方法"><a href="#使用fishhook-objc-msgSend-方法" class="headerlink" title="使用fishhook objc_msgSend 方法"></a>使用fishhook <code>objc_msgSend</code> 方法</h3><p>Hook <code>objc_msgSend</code>方法要保证栈平衡。<br>参考戴老师的方法</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 寄的value放到x12寄存器中，通过寄存器寻址跳转到地址</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">call</span>(b, value) \</span><br><span class="line"><span class="selector-tag">__asm</span> <span class="selector-tag">volatile</span> (<span class="string">"stp x8, x9, [sp, #-16]!\n"</span>); \</span><br><span class="line"><span class="selector-tag">__asm</span> <span class="selector-tag">volatile</span> (<span class="string">"mov x12, %0\n"</span> :: <span class="string">"r"</span>(value)); \</span><br><span class="line"><span class="selector-tag">__asm</span> <span class="selector-tag">volatile</span> (<span class="string">"ldp x8, x9, [sp], #16\n"</span>); \</span><br><span class="line"><span class="selector-tag">__asm</span> <span class="selector-tag">volatile</span> (<span class="number">#b</span> <span class="string">" x12\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把x0~x9的寄存器保存起来，</span></span><br><span class="line"><span class="comment">// 保存x9据说为了内存对齐</span></span><br><span class="line"><span class="comment">// 如果这里用到浮点数，还要把q0~q9保存起来</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">save</span>() \</span><br><span class="line"><span class="selector-tag">__asm</span> <span class="selector-tag">volatile</span> ( \</span><br><span class="line"><span class="string">"stp x8, x9, [sp, #-16]!\n"</span> \</span><br><span class="line"><span class="string">"stp x6, x7, [sp, #-16]!\n"</span> \</span><br><span class="line"><span class="string">"stp x4, x5, [sp, #-16]!\n"</span> \</span><br><span class="line"><span class="string">"stp x2, x3, [sp, #-16]!\n"</span> \</span><br><span class="line"><span class="string">"stp x0, x1, [sp, #-16]!\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从栈里面把数据读取出来，恢复寄存器</span></span><br><span class="line"><span class="comment">// 调整sp指针</span></span><br><span class="line"><span class="selector-id">#define</span> <span class="selector-tag">load</span>() \</span><br><span class="line"><span class="selector-tag">__asm</span> <span class="selector-tag">volatile</span> ( \</span><br><span class="line"><span class="string">"ldp x0, x1, [sp], #16\n"</span> \</span><br><span class="line"><span class="string">"ldp x2, x3, [sp], #16\n"</span> \</span><br><span class="line"><span class="string">"ldp x4, x5, [sp], #16\n"</span> \</span><br><span class="line"><span class="string">"ldp x6, x7, [sp], #16\n"</span> \</span><br><span class="line"><span class="string">"ldp x8, x9, [sp], #16\n"</span> );</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">__attribute__</span>((__naked__))</span><br><span class="line"><span class="selector-tag">static</span> <span class="selector-tag">void</span> <span class="selector-tag">hook_Objc_msgSend</span>() &#123;</span><br><span class="line">    <span class="comment">// Save parameters.</span></span><br><span class="line">    <span class="comment">/// 保存寄存器的参数到栈里面</span></span><br><span class="line">    <span class="comment">/// Step 1</span></span><br><span class="line">    <span class="selector-tag">save</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Step 2</span></span><br><span class="line">    <span class="comment">// 保存lr寄存器到第三个寄存器中，_before_objc_msgSend的方法，第三个参数就是lr</span></span><br><span class="line">    <span class="selector-tag">__asm</span> <span class="selector-tag">volatile</span> (<span class="string">"mov x2, lr\n"</span>);</span><br><span class="line">    <span class="selector-tag">__asm</span> <span class="selector-tag">volatile</span> (<span class="string">"mov x3, x4\n"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 此时的x0、x1，就是objc_msgSend方法里面的id,sel</span></span><br><span class="line">    <span class="selector-tag">call</span>(blr, &amp;before_objc_msgSend)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 从栈里面取出参数到放到寄存器中</span></span><br><span class="line">    <span class="selector-tag">load</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 调用原来的msg_send方法</span></span><br><span class="line">    <span class="selector-tag">call</span>(blr, orig_objc_msgSend)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 保存原来</span></span><br><span class="line">    <span class="selector-tag">save</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 调用after_objc_msgSend方法，这个方法要把lr寄存器的地址返回。</span></span><br><span class="line">    <span class="selector-tag">call</span>(blr, &amp;after_objc_msgSend)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 上面调用after_objc_msgSend返回的lr寄存器地址会放到x0里面，所以我们把x0恢复到原来的lr寄存器即可</span></span><br><span class="line">    <span class="selector-tag">__asm</span> <span class="selector-tag">volatile</span> (<span class="string">"mov lr, x0\n"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 恢复上下文</span></span><br><span class="line">    <span class="selector-tag">load</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用返回方法</span></span><br><span class="line">    <span class="selector-tag">ret</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修改静态库的符号表"><a href="#修改静态库的符号表" class="headerlink" title="修改静态库的符号表"></a>修改静态库的符号表</h3><p>这个方案来自：<a href="https://juejin.cn/post/6844904038564102151" target="_blank" rel="noopener">静态拦截iOS对象方法调用的简易实现</a></p>
<p>原理：修改静态库的符号名，在静态链接时就能链接到修改后的方法</p>
<p>定义Person.m 文件</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sayHelloToWorld &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"1+2=3"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>用<code>clang</code>把.m文件生成.o目标文件，</p>
<blockquote>
<p>clang -arch arm64 -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS14.0.sdk -c Person.m -o Person.o</p>
</blockquote>
<p>现在的文件还未链接，跳转<code>NSLog</code>符号的地址还没定，一旦链接到<code>bl</code>跳转的地址就是目标地址</p>
<p><img src="http://note.youdao.com/yws/res/11246/6EEA0BE4170A46988215D4E367E076FE" alt="image"><br><img src="http://note.youdao.com/yws/res/11248/7B03A43F1F6A4AFABC27743141C89255" alt="image"><br><img src="http://note.youdao.com/yws/res/11250/02A93820DB4443F69D3E161BDEC3BCB5" alt="image"><br><img src="http://note.youdao.com/yws/res/11252/02E14EBDAB834EE288E4FC4D533AECA7" alt="image"></p>
<p>这样子就能找到符号了，如果我们把<code>0x0928</code>位置的<code>N</code>字符改成<code>O</code>。就会变成下面<code>OSLog</code>这个方法<br><img src="http://note.youdao.com/yws/res/11256/C00F6FD9CC184271A1E8EA206B06EF8E" alt="image"><br><img src="http://note.youdao.com/yws/res/11258/B2F9336038DA4D21B935D55EBB70D82B" alt="image"></p>
<p>我们在主工程定义了<code>OSLog</code>方法，在静态链接就会链接到这个方法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/20/fishhook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/20/fishhook/" itemprop="url">fishhook 原理笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-20T11:36:55+08:00">
                2020-11-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在OC中想在hook一个函数，绝对是利用runtime swizzle 方法。但是对于c函数我们应该怎么hook呢？<br>没错，就是利用今天的主角fishhook</p>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><p>我们以 hook <code>NSlog()</code> 为例</p>
<p>先定义我们自己的 <code>log</code> 函数 与 <code>NSLog</code> 的函数指针</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void <span class="keyword">mLog</span>(NSString * <span class="keyword">format</span>, ...) &#123;</span><br><span class="line">    <span class="keyword">format</span> = [<span class="keyword">format</span> stringByAppendingFormat:@<span class="string">"勾上了！\n"</span>];</span><br><span class="line">    sys_nslog(<span class="keyword">format</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void(*sys_nslog)(NSString * <span class="keyword">format</span>, ...);</span><br></pre></td></tr></table></figure>
<p>声明 <code>rebinding</code> 的结构体。这个结构体包含了重新绑定的信息。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> <span class="title">nslog</span>;</span></span><br><span class="line">nslog.name = <span class="string">"NSLog"</span>;</span><br><span class="line">nslog.replacement = mLog;</span><br><span class="line">nslog.replaced = (<span class="keyword">void</span> *)&amp;sys_nslog;</span><br><span class="line"><span class="comment">//rebinding结构体数组</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> <span class="title">rebs</span>[1] = &#123;</span>nslog&#125;;</span><br><span class="line"></span><br><span class="line">rebind_symbols(rebs, <span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>
<p>最终我们调用 <code>NSLog</code>方法，打印如下：</p>
<blockquote>
<p> xxx 勾上了！</p>
</blockquote>
<p>此处有一个小问题？如果在这个项目里面的 c 函数能hook住吗？答案是不能！</p>
<h3 id="原理解释"><a href="#原理解释" class="headerlink" title="原理解释"></a>原理解释</h3><p>新建一个项目，在<code>ViewDidload</code>里面打印文本，把生成的可执行文件拖到 Hopper Disassembler 中。<br><img src="http://note.youdao.com/yws/res/11074/3E4E5CE8E1784419AA9987A131D32AB1" alt="image"><br><img src="http://note.youdao.com/yws/res/11076/FD07B897C3AB4054B8DBCE6A09D97430" alt="image"></p>
<p>这里跳到 <code>imp__stubs_NSLog</code> 这个位置，进来继续看<br><img src="http://note.youdao.com/yws/res/11079/34EF700BA34D4EFBAFFAA07AD2B18E3E" alt="image"><br>上面是把 <code>0x0c00</code> 位置的值放到x16寄存器上，我们看一下地址</p>
<p><img src="http://note.youdao.com/yws/res/11081/A26D9FE9259648F9AC3CC5D1AF87C34E" alt="image"><br>找到 <code>0x0C000</code> 的地址，这里是 <code>Data Segment</code>，<code>__la_symbol_ptr Section</code>。这里有两个点很重要：</p>
<ul>
<li>属于<code>Data</code>段，可读写</li>
<li><code>__la_symbol_ptr section</code> 是存放着动态链接的符号表，这里面的符号会在该符号被调用时，通过dyld的<code>dyld_stb_binder</code>过程进行加载。<br>还有一种动态链接相关的表是 <code>__nl_symbol_ptr</code> 表示在动态链接库绑定的时候进行加载的</li>
</ul>
<p>到这里就很显示了，fishhook 就是通过修改 <code>__la_symbol_ptr</code> 这张符号表里面的值来达到hook c函数的目的。<br>下面我们来验证一下</p>
<h3 id="原理验证"><a href="#原理验证" class="headerlink" title="原理验证"></a>原理验证</h3><p>在一个新项目的<code>ViewController</code>里面写上面代码，然后我们关注 <code>__nl_symbol_ptr</code> 这个符号表里面<code>NSLog</code> 对应地址的变化。把可执行文件拖到 <code>MachOView</code>里面<br><img src="http://note.youdao.com/yws/res/11084/56B20444852F487B9FEC5E0DCCBD9D9A" alt="image"><br><img src="http://note.youdao.com/yws/res/11087/FCFC1F2CA5734559B74D21105AB1C077" alt="image"><br>位置是这个<code>0xc000</code>，运行程序，进入断点。找到<code>ALSR</code>的偏移地址<br><img src="http://note.youdao.com/yws/res/11089/25D8F304A6B94246B9E29435A4BD1A14" alt="image"></p>
<p><img src="http://note.youdao.com/yws/res/11092/CEFFF74E73734F88B3293D009B413689" alt="image"><br>lldb <code>x</code>命令指地址的值读出来，<code>dis -s</code> 以当前赋值的地址反汇编。<br>可以看出来，我们<code>NSLog</code> 调用的地址，暂时看不出来是什么（实际是调了<code>dyld_stb_binder</code>相关函数，进行动态绑定)。</p>
<p>接下来，我们继续走下一步，NSLog动态符号表对应的值 发生改变，对当前地址反汇编后发现是 <code>Foundation</code> 的<code>NSLog</code> 方法。</p>
<p><img src="http://note.youdao.com/yws/res/11096/19F11E662F9748CA8E3436BCFC814599" alt="image"></p>
<p>最后，让代码继续走过<code>rebind_symbols</code>方法，又又发现<code>NSLog</code>动态符号表对应的值 发生改变，对当前地址反汇编后发现是我们自定义的方法</p>
<p><img src="http://note.youdao.com/yws/res/11098/CD88539E45FF489DABF380BA2AC4BD2A" alt="image"></p>
<p>结论很明显，<code>__nl_symbol_ptr</code> 处于Data段，可读写。动态符号可通过这里对应的地址值进行跳转，<code>fishhook</code>就是通过修改这里的值达到Hook目的。</p>
<h3 id="fishhook源码解读"><a href="#fishhook源码解读" class="headerlink" title="fishhook源码解读"></a>fishhook源码解读</h3><p>拿<code>Mach-O</code>文件和源码的操作一起对着来看。</p>
<h4 id="rebind-symbols-方法"><a href="#rebind-symbols-方法" class="headerlink" title="rebind_symbols 方法"></a>rebind_symbols 方法</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(struct rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 把要被hook的函数信息用链表保存起来</span></span><br><span class="line">    <span class="comment">// 头插法的形式添加到_rebindings_head这里</span></span><br><span class="line">  <span class="keyword">int</span> retval = prepend_rebindings(&amp;_rebindings_head, rebindings, rebindings_nel);</span><br><span class="line">  <span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 第一次的话调用，注册加载镜像的方法_dyld_register_func_for_add_image，</span></span><br><span class="line">  <span class="comment">// 如果已经加载过的镜像，会直接调用回调方法。其他的会在加载的时候回调）</span></span><br><span class="line">  <span class="keyword">if</span> (!_rebindings_head-&gt;next) &#123;</span><br><span class="line">    _dyld_register_func_for_add_image(_rebind_symbols_for_image);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> c = _dyld_image_count();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; c; i++) &#123;</span><br><span class="line">      _rebind_symbols_for_image(_dyld_get_image_header(i), _dyld_get_image_vmaddr_slide(i));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一步：preped_rebindings，这部分主要是把 rebindings_entry 以一个链表的形式保存起来。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> int prepend_rebindings(struct rebindings_entry **rebindings_head,</span><br><span class="line">                              struct rebinding rebindings[],</span><br><span class="line">                              size_t nel) &#123;</span><br><span class="line">  struct rebindings_entry *<span class="keyword">new</span><span class="type">_entry</span> = malloc(sizeof(struct rebindings_entry));</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">new</span><span class="type">_entry</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">new</span><span class="type">_entry</span>-&gt;rebindings = malloc(sizeof(struct rebinding) * nel);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">new</span><span class="type">_entry</span>-&gt;rebindings) &#123;</span><br><span class="line">    free(<span class="keyword">new</span><span class="type">_entry</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 头插法，把数据保存起来</span></span><br><span class="line">  memcpy(<span class="keyword">new</span><span class="type">_entry</span>-&gt;rebindings, rebindings, sizeof(struct rebinding) * nel);</span><br><span class="line">  <span class="keyword">new</span><span class="type">_entry</span>-&gt;rebindings_nel = nel;</span><br><span class="line">  <span class="keyword">new</span><span class="type">_entry</span>-&gt;next = *rebindings_head;</span><br><span class="line">  *rebindings_head = <span class="keyword">new</span><span class="type">_entry</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面看到，入口函数最终会调到_rebind_symbols_for_image，从页调到rebind_symbols_for_image这个函数里面。<br><figure class="highlight thrift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static <span class="keyword">void</span> _rebind_symbols_for_image(<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mach_header</span> *header,</span></span><br><span class="line"><span class="class">                                      intptr_t slide) </span>&#123;</span><br><span class="line">    rebind_symbols_for_image(_rebindings_head, header, slide);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="rebind-symbols-for-image"><a href="#rebind-symbols-for-image" class="headerlink" title="rebind_symbols_for_image"></a>rebind_symbols_for_image</h4><p>其实重头戏也在这个(rebind_symbols_for_image)函数里面，</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> @param rebindings 需要被交换方法的数组</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> @param header Mach-O文件的header，通过_dyld_get_image_header获取</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> @param slide ASLR的偏移地址(_dyld_get_image_vmaddr_slide获取)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rebind_symbols_for_image</span>(<span class="params"><span class="keyword">struct</span> rebindings_entry *rebindings,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">const</span> <span class="keyword">struct</span> mach_header *header,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     intptr_t slide</span>)</span> &#123;</span><br></pre></td></tr></table></figure>
<p>这里可以分三部分来讲解：</p>
<p><strong>第一部分：确定这个header是否合法</strong></p>
<p>dladdr函数主要作用是获取 &amp;info 所在动态库的信息，如果获取不到，就证明这个header地址是不合法的。</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dl_info info;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">dladdr</span>(<span class="built_in">header</span>, &amp;info) == <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>第二部分：可以看到在查找三个 load_command</strong></p>
<p>分别是<br>linkedit_segment、symtab_cmd、dysymtab_cmd，</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loadCommand的开始地址在header的后面</span></span><br><span class="line">    uintptr_t cur = (uintptr_t)<span class="built_in">header</span> + <span class="built_in">sizeof</span>(mach_header_t);</span><br><span class="line">    <span class="comment">// 遍历所有的loadCommands</span></span><br><span class="line">    <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; <span class="built_in">header</span>-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">        cur_seg_cmd = (segment_command_t *)cur;</span><br><span class="line">        <span class="comment">// Command为LC_SEGMENT_64有好几个（PAGEZERO, TEXT, DATA_COST, DATA, LINKEDIT)</span></span><br><span class="line">        <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">            <span class="comment">// 根据segmentName 找到linkedit_segment</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_LINKEDIT) == <span class="number">0</span>) &#123;</span><br><span class="line">                linkedit_segment = cur_seg_cmd;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SYMTAB) &#123;</span><br><span class="line">            symtab_cmd = (<span class="keyword">struct</span> <span class="type">symtab_command</span>*)<span class="type">cur_seg_cmd</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_DYSYMTAB) &#123;</span><br><span class="line">            dysymtab_cmd = (<span class="keyword">struct</span> <span class="type">dysymtab_command</span>*)<span class="type">cur_seg_cmd</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果上面的三个loadCommand有一个有空，就返回</span></span><br><span class="line">    <span class="keyword">if</span> (!symtab_cmd || !dysymtab_cmd || !linkedit_segment ||</span><br><span class="line">        !dysymtab_cmd-&gt;nindirectsyms) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>分析一下这三个LoadCommand主要会加载哪些信息</p>
<p><strong>LINKEDIT Commond</strong></p>
<p><img src="http://note.youdao.com/yws/res/11102/F5E0CE7273D9491BBF80EDBF3E9A74E1" alt="image"></p>
<p><img src="http://note.youdao.com/yws/res/11104/4E29A4C157B74B1BBC123FF7A45B9E30" alt="image"></p>
<p>根据地址可以看到，linkedit_segment 这个命令是用于加载 Dynamic Loader Info 相关的信息。</p>
<p><strong>LC_SYMTAB(符号表)</strong></p>
<p><img src="http://note.youdao.com/yws/res/11118/FE859280434E41B9B586AAF9D3FF42A6" alt="image"><br><img src="http://note.youdao.com/yws/res/11120/E0F65B3221AC4A209900176EC8386012" alt="image"></p>
<p><strong>LC_DYSYMTAB(动态符号表相关)</strong></p>
<p><img src="http://note.youdao.com/yws/res/11122/62D4609C42D14B088C640625E4C5F3AE" alt="image"></p>
<p>我们能看到这个 <code>IndSym Table Offset</code> 的值是 <code>0x11648</code>，其他的符号表的offset 是0。</p>
<blockquote>
<p><code>IndSym Table Offset</code> 用于存放在字符表的位置</p>
</blockquote>
<p><img src="http://note.youdao.com/yws/res/11125/D0E6EE3AD8A24C978CE929AAAA132E2A" alt="image"><br>通过上面的分析，我们搞明白了上面这几个load_command的作用了。那么回过头业，继续往下看第三部分</p>
<p><strong>第三部分找到各个 符号表地址、字符串表地址、动态符号表地址，然后调用重新绑定函数的方法进行替换</strong></p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Find base symbol/string table addresses</span></span><br><span class="line"><span class="comment">//链接时程序的基址 = __LINKEDIT.VM_Address -__LINKEDIT.File_Offset + silde的改变值</span></span><br><span class="line"><span class="function"><span class="title">uintptr_t</span> linkedit_base = (uintptr_t)<span class="built_in">slide</span> + linkedit_segment-&gt;</span><span class="function"><span class="title">vmaddr</span> - linkedit_segment-&gt;</span>fileoff;</span><br><span class="line"><span class="comment">//符号表的地址 = 基址 + 符号表偏移量</span></span><br><span class="line"><span class="function"><span class="title">nlist_t</span> *symtab = (nlist_t *)(linkedit_base + symtab_cmd-&gt;</span>symoff);</span><br><span class="line"><span class="comment">//字符串表的地址 = 基址 + 字符串表偏移量</span></span><br><span class="line"><span class="function"><span class="title">char</span> *strtab = (char *)(linkedit_base + symtab_cmd-&gt;</span>stroff);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get indirect symbol table (array of uint32_t indices into symbol table)</span></span><br><span class="line"><span class="comment">//动态符号表地址 = 基址 + 动态符号表偏移量</span></span><br><span class="line"><span class="function"><span class="title">uint32_t</span> *indirect_symtab = (uint32_t *)(linkedit_base + dysymtab_cmd-&gt;</span>indirectsymoff);</span><br><span class="line"></span><br><span class="line">cur = (uintptr_t)header + sizeof(mach_header_t);</span><br><span class="line"><span class="function"><span class="title">for</span> (uint i = 0; i &lt; header-&gt;</span><span class="function"><span class="title">ncmds</span>; i++, cur += cur_seg_cmd-&gt;</span>cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd = (segment_command_t *)cur;</span><br><span class="line">    <span class="function"><span class="title">if</span> (cur_seg_cmd-&gt;</span>cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">        <span class="comment">//非Data段的数据过滤掉，__la_symbol_ptr和__no_la_symbol_ptr(got)这两个section都是放在Data段上</span></span><br><span class="line">        <span class="function"><span class="title">if</span> (strcmp(cur_seg_cmd-&gt;</span>segname, SEG_DATA) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            <span class="function"><span class="title">strcmp</span>(cur_seg_cmd-&gt;</span>segname, SEG_DATA_CONST) != <span class="number">0</span>) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="title">for</span> (uint j = 0; j &lt; cur_seg_cmd-&gt;</span>nsects; j++) &#123;</span><br><span class="line">            section_t *sect =</span><br><span class="line">            (section_t *)(cur + sizeof(segment_command_t)) + j;</span><br><span class="line">            <span class="comment">//找懒加载表</span></span><br><span class="line">            <span class="function"><span class="title">if</span> ((sect-&gt;</span>flags &amp; SECTION_TYPE) == S_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">                perform_rebinding_with_section(rebindings, sect, <span class="built_in">slide</span>, symtab, strtab, indirect_symtab);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//非懒加载表</span></span><br><span class="line">            <span class="function"><span class="title">if</span> ((sect-&gt;</span>flags &amp; SECTION_TYPE) == S_NON_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">                perform_rebinding_with_section(rebindings, sect, <span class="built_in">slide</span>, symtab, strtab, indirect_symtab);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/res/11131/F2EA10D9D2C44B5795BD2C5F9A9834CE" alt="image"></p>
<p>至于为什么叫 <code>got</code> 段，估计是和 ELF 文件有关系</p>
<p>找到了这 <code>__la_symbol_prt</code> <code>Section</code>的位置后，就进入了查找符号位置，替换方法的逻辑。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 找到符号表所对应的位置进行绑定</span></span><br><span class="line"><span class="comment">/// @param rebindings rebindings 要交换的数组</span></span><br><span class="line"><span class="comment">/// @param section section_t当前loadcommand的section(__la_symbol_ptr, __no_la_symbol_ptr)</span></span><br><span class="line"><span class="comment">/// @param slide slide alsr程序偏移</span></span><br><span class="line"><span class="comment">/// @param symtab 符号表地址 10608</span></span><br><span class="line"><span class="comment">/// @param strtab 字符串表地址 11708</span></span><br><span class="line"><span class="comment">/// @param indirect_symtab 动态符号表地址 11648</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">perform_rebinding_with_section</span><span class="params">(struct rebindings_entry *rebindings,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">section_t</span> *section,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">intptr_t</span> slide,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">nlist_t</span> *symtab,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">char</span> *strtab,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">uint32_t</span> *indirect_symtab)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取__la_symbol_ptr 和 __no_la_symbol的在Indirect Symbols的起始位置</span></span><br><span class="line">    <span class="keyword">uint32_t</span> *indirect_symbol_indices = indirect_symtab + section-&gt;reserved1;</span><br><span class="line">    <span class="comment">//slide+section-&gt;addr 就是符号对应的存放函数实现的数组也就是我相应的__nl_symbol_ptr和__la_symbol_ptr相应的函数指针都在这里面了，所以可以去寻找到函数的地址</span></span><br><span class="line">    <span class="keyword">void</span> **indirect_symbol_bindings = (<span class="keyword">void</span> **)((<span class="keyword">uintptr_t</span>)slide + section-&gt;addr); <span class="comment">// 0xc000 (__DATA, __la_symbol_ptr的地址)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//遍历__la_symbol_ptr/ __no_la_symbol 里面的所有符号</span></span><br><span class="line">    <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; section-&gt;<span class="built_in">size</span> / <span class="keyword">sizeof</span>(<span class="keyword">void</span> *); i++) &#123;</span><br><span class="line">        <span class="comment">//找到符号在Indrect Symbol Table表中的值</span></span><br><span class="line">        <span class="comment">//读取indirect table中的数据</span></span><br><span class="line">        <span class="keyword">uint32_t</span> symtab_index = indirect_symbol_indices[i];</span><br><span class="line">        <span class="keyword">if</span> (symtab_index == INDIRECT_SYMBOL_ABS || symtab_index == INDIRECT_SYMBOL_LOCAL ||</span><br><span class="line">            symtab_index == (INDIRECT_SYMBOL_LOCAL   | INDIRECT_SYMBOL_ABS)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//以symtab_index作为下标，访问symbol table</span></span><br><span class="line">        <span class="keyword">uint32_t</span> strtab_offset = symtab[symtab_index].n_un.n_strx;</span><br><span class="line">        <span class="comment">//获取到symbol_name</span></span><br><span class="line">        <span class="keyword">char</span> *symbol_name = strtab + strtab_offset;</span><br><span class="line">        <span class="comment">//判断是否函数的名称是否有两个字符，为啥是两个，因为函数前面有个_，所以方法的名称最少要1个</span></span><br><span class="line">        <span class="keyword">bool</span> symbol_name_longer_than_1 = symbol_name[<span class="number">0</span>] &amp;&amp; symbol_name[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">//遍历最初的链表，来进行hook</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">cur</span> = <span class="title">rebindings</span>;</span></span><br><span class="line">        <span class="keyword">while</span> (cur) &#123;</span><br><span class="line">            <span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line">                <span class="comment">//这里if的条件就是判断从symbol_name[1]两个函数的名字是否都是一致的，以及判断两个</span></span><br><span class="line">                <span class="keyword">if</span> (symbol_name_longer_than_1 &amp;&amp;</span><br><span class="line">                    <span class="built_in">strcmp</span>(&amp;symbol_name[<span class="number">1</span>], cur-&gt;rebindings[j].name) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//判断replaced的地址不为NULL以及我方法的实现和rebindings[j].replacement的方法不一致</span></span><br><span class="line">                    <span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">                        indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">                        <span class="comment">//让rebindings[j].replaced保存indirect_symbol_bindings[i]的函数地址</span></span><br><span class="line">                        *(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//将替换后的方法给原先的方法，也就是替换内容为自定义函数地址</span></span><br><span class="line">                    indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line">                    <span class="keyword">goto</span> symbol_loop;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cur = cur-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    symbol_loop:;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>下面以<code>NSLog</code>为例，一步一步使用 <code>Mach-O</code>对应的把流程走完看看，（<code>NSLog</code> 在 <code>__la_symbol_ptr</code> 符号表里面）</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">uint32_t</span> *indirect_symbol_indices = indirect_symtab + section-&gt;</span>reserved1; <span class="comment">// 获取 __la_symbol_ptr 符号在 indSymBol的开始位置。</span></span><br></pre></td></tr></table></figure>
<p><img src="http://note.youdao.com/yws/res/11134/390BDA93A84D4804A870194A5C6BA337" alt="image"></p>
<p>下面这图可以看到在<code>Indirect Symbols</code> 偏移是 0x19，也就是第25个。<br><img src="http://note.youdao.com/yws/res/11136/032ECA434D004DBB8D62BC59429FA9F5" alt="image"></p>
<p>走到这步, 其实就是 <code>__la_symbol_ptr</code>的位置<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void **indirect_symbol_bindings = (<span class="name">void</span> **)((<span class="name">uintptr_t</span>)slide + section-&gt;addr)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/res/11141/7D700537F35D4A54B4D4B4DFA22DF5B3" alt="image"></p>
<p>进入for 循环第一句，获取在 symtab_index，在 0xE3 这个位置<br>uint32_t symtab_index = indirect_symbol_indices[i];</p>
<p><img src="http://note.youdao.com/yws/res/11143/D4B2F03BAE984DD68B4C39294D299B89" alt="image"></p>
<p>根据在 符号表里面的Index(0xE3 = 227)，取到符号对象，并获取在字符串表 strtab的位置。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以symtab_index作为下标，访问symbol table</span></span><br><span class="line"><span class="keyword">uint32_t</span> strtab_offset = symtab[symtab_index].n_un.n_strx;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/res/11145/59BC19B3C3764FAF860D87B0E490C739" alt="image"></p>
<p>所以我们取到的字符的位置 0x11708 + 0xD4 = 0x117DC<br><img src="http://note.youdao.com/yws/res/11147/BE8A884242424E34987CE975B362F38F" alt="image"></p>
<p>然后判断symbol是否大于一，因为前面的 “_”字符是编译期加上的。<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool symbol_name_longer_than_1 = symbol_name<span class="comment">[0]</span> &amp;&amp; symbol_name<span class="comment">[1]</span>;</span><br></pre></td></tr></table></figure></p>
<p>进入while循环，把rebindings都过一遍，看看和上面字符相等的函数名，进行方法替换。<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (cur) &#123;</span><br><span class="line">    <span class="function"><span class="title">for</span> (uint j = 0; j &lt; cur-&gt;</span>rebindings_nel; j++) &#123;</span><br><span class="line">        <span class="comment">//这里if的条件就是判断从symbol_name[1]两个函数的名字是否都是一致的，以及判断两个</span></span><br><span class="line">        <span class="keyword">if</span> (symbol_name_longer_than_1 &amp;&amp;</span><br><span class="line">            <span class="function"><span class="title">strcmp</span>(&amp;symbol_name[1], cur-&gt;</span>rebindings[j].<span class="keyword">name</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//判断replaced的地址不为NULL以及我方法的实现和rebindings[j].replacement的方法不一致</span></span><br><span class="line">            <span class="function"><span class="title">if</span> (cur-&gt;</span>rebindings[j].replaced != NULL &amp;&amp;</span><br><span class="line">                <span class="function"><span class="title">indirect_symbol_bindings</span>[i] != cur-&gt;</span>rebindings[j].replacement) &#123;</span><br><span class="line">                <span class="comment">//让rebindings[j].replaced保存indirect_symbol_bindings[i]的函数地址</span></span><br><span class="line">                *(<span class="function"><span class="title">cur</span>-&gt;</span>rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将替换后的方法给原先的方法，也就是替换内容为自定义函数地址</span></span><br><span class="line">            <span class="function"><span class="title">indirect_symbol_bindings</span>[i] = cur-&gt;</span>rebindings[j].replacement;</span><br><span class="line">            goto symbol_loop;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">cur</span> = cur-&gt;</span>next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们回顾一下上面查找符号的过程：<br><img src="http://note.youdao.com/yws/res/11149/7B84BD213F1847099B1AA972630B3A59" alt="image"></p>
<ol>
<li>从 <code>Loadcomamd</code> 的 <code>reserved1</code> 的位置，找到在 <code>Indirect Symbol Table</code> 的开始位置。</li>
<li>进入循环，从开始位置遍历 <code>Indirect Symbol Table</code>，长度是<code>Section.size</code></li>
<li>遍历过程中，拿到<code>Symbol Table</code>的位置，从而知道符号的字符串</li>
<li>遍历过程中, 字符串和被替换相匹配，如果匹配就进行替换函数。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/11/swift-style-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/11/swift-style-guide/" itemprop="url">编码规范</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-11T16:39:54+08:00">
                2018-12-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/其他/" itemprop="url" rel="index">
                    <span itemprop="name">其他</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Swift-编码规范"><a href="#Swift-编码规范" class="headerlink" title="Swift 编码规范"></a>Swift 编码规范</h1><h2 id="正确性"><a href="#正确性" class="headerlink" title="正确性"></a>正确性</h2><p>尽量使代码在没有警告下编译</p>
<h3 id="命名"><a href="#命名" class="headerlink" title="命名"></a>命名</h3><p>描述性和一致性的命名会使代码更新易读易懂，使用<code>Swift</code>官方命名约定中描述的 <a href="https://swift.org/documentation/api-design-guidelines/" target="_blank" rel="noopener">API Design Guidelines</a>。现总结常用几点：</p>
<ul>
<li>避免不常用的缩写</li>
<li>命名清晰比简洁重要</li>
<li>使用驼峰命名方法</li>
<li>类、协议、枚举不用像<code>Objectice-c</code>那样添加前缀</li>
</ul>
<h3 id="类前缀"><a href="#类前缀" class="headerlink" title="类前缀"></a>类前缀</h3><p>Swift 自动以模块名称作为命名空间，不需要给类添加前缀，例如：RW。如果相同的两个类在不同的命名空间下，可以增加模块名字作为前缀。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import</span> SomeModule</span><br><span class="line"><span class="keyword">let</span> <span class="attr">myClass</span> = MyModule.UsefulClass()</span><br></pre></td></tr></table></figure>
<h3 id="Delegate"><a href="#Delegate" class="headerlink" title="Delegate"></a>Delegate</h3><p>在创建自定义的<code>delegate</code>方法时，第一个参数不带名字的参数应该是<code>delegate</code>原来的对象</p>
<p><strong>Preferred</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">namePickerView</span><span class="params">(<span class="number">_</span> namePickerView: NamePickerView, didSelectName name: String)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">namePickerViewShouldReload</span><span class="params">(<span class="number">_</span> namePickerView: NamePickerView)</span></span> -&gt; <span class="type">Bool</span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">didSelectName</span><span class="params">(namePicker: NamePickerViewController, name: String)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">namePickerShouldReload</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span></span><br></pre></td></tr></table></figure>
<h3 id="使用类型推断上下文"><a href="#使用类型推断上下文" class="headerlink" title="使用类型推断上下文"></a>使用类型推断上下文</h3><p>使用类型推断可以使代码整洁 (可参考<a href="#type-inference">Type Inference</a>.)</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> selector = #selector(viewDidLoad)</span><br><span class="line">view.backgroundColor = .red</span><br><span class="line"><span class="keyword">let</span> toView = context.view(forKey: .to)</span><br><span class="line"><span class="keyword">let</span> view = <span class="type">UIView</span>(frame: .zero)</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> selector = #selector(<span class="type">ViewController</span>.viewDidLoad)</span><br><span class="line">view.backgroundColor = <span class="type">UIColor</span>.red</span><br><span class="line"><span class="keyword">let</span> toView = context.view(forKey: <span class="type">UITransitionContextViewKey</span>.to)</span><br><span class="line"><span class="keyword">let</span> view = <span class="type">UIView</span>(frame: <span class="type">CGRect</span>.zero)</span><br></pre></td></tr></table></figure>
<h3 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h3><p>泛型命名应该是可描述性的，使用驼峰命名。当类型名字没有意义时，使用传统的大写字母：T，U 或者 V</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Stack</span>&lt;<span class="title">Element</span>&gt; </span>&#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span>&lt;Target: OutputStream&gt;<span class="params">(to target: <span class="keyword">inout</span> Target)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span>&lt;T&gt;<span class="params">(<span class="number">_</span> a: <span class="keyword">inout</span> T, <span class="number">_</span> b: <span class="keyword">inout</span> T)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Stack</span>&lt;<span class="title">T</span>&gt; </span>&#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span>&lt;target: OutputStream&gt;<span class="params">(to target: <span class="keyword">inout</span> target)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span>&lt;Thing&gt;<span class="params">(<span class="number">_</span> a: <span class="keyword">inout</span> Thing, <span class="number">_</span> b: <span class="keyword">inout</span> Thing)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="类和结构体"><a href="#类和结构体" class="headerlink" title="类和结构体"></a>类和结构体</h2><h3 id="应该用哪个"><a href="#应该用哪个" class="headerlink" title="应该用哪个"></a>应该用哪个</h3><p>结构体是<a href="https://developer.apple.com/library/mac/documentation/Swift/Conceptual/Swift_Programming_Language/ClassesAndStructures.html#//apple_ref/doc/uid/TP40014097-CH13-XID_144" target="_blank" rel="noopener">值类型</a>。使用结构体的对象是不具有唯一性，例如：数组[a,b,c]和另外的一个定义在其他的数组[a,b,c]是可以互换的。不管是第一个数组还是第二个数组，它们所代表的含义是一样的。这就是为什么数组是结构体的原因。</p>
<p>类是<a href="https://developer.apple.com/library/mac/documentation/Swift/Conceptual/Swift_Programming_Language/ClassesAndStructures.html#//apple_ref/doc/uid/TP40014097-CH13-XID_145" target="_blank" rel="noopener">引用类型</a>。对拥有自己的id或者有生命周期的事物使用类。常常把人建模为一个类，两个人的对象是不同的东西，就算他们有相同的名字和生日，也不意味着他们是同一个人。但是生日应该为结构体，因为1950年3月的日期跟其他相同日期表示的意思是一样的。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>这是一个比较不错的定义Class的例子</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span>: <span class="title">Shape</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x: <span class="type">Int</span></span><br><span class="line">  <span class="keyword">var</span> y: <span class="type">Int</span></span><br><span class="line">  <span class="keyword">var</span> radius: <span class="type">Double</span></span><br><span class="line">  <span class="keyword">var</span> diameter: <span class="type">Double</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> radius * <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">      radius = newValue / <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">init</span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>, radius: <span class="type">Double</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.x = x</span><br><span class="line">    <span class="keyword">self</span>.y = y</span><br><span class="line">    <span class="keyword">self</span>.radius = radius</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">convenience</span> <span class="keyword">init</span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>, diameter: <span class="type">Double</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.<span class="keyword">init</span>(x: x, y: y, radius: diameter / <span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">area</span><span class="params">()</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Double</span>.pi * radius * radius</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//MARK: - CustomStringConvertible</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> description: <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"center = \(centerString) area = \(area())"</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> centerString: <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"(\(x),\(y))"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用Self"><a href="#使用Self" class="headerlink" title="使用Self"></a>使用Self</h3><p>为了简洁起见，避免使用<code>self</code>，因为<code>Swift</code>不强求使用<code>self</code>来访问对象的属性或者调用方法。</p>
<p>只有在编译器要求使用<code>self</code>的时候，（在<code>@escaping</code>闭包里面或者在对象初始化的方法里面为了消除歧义），否则在没有编译器提醒时都应该省略它</p>
<h3 id="计算属性"><a href="#计算属性" class="headerlink" title="计算属性"></a>计算属性</h3><p><strong>Preferred</strong>:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var diameter: Double &#123;</span><br><span class="line">  return<span class="built_in"> radius </span>* 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var diameter: Double &#123;</span><br><span class="line">  <span class="builtin-name">get</span> &#123;</span><br><span class="line">    return<span class="built_in"> radius </span>* 2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Final关键字"><a href="#Final关键字" class="headerlink" title="Final关键字"></a>Final关键字</h3><p>如果你的类不需要派生子类，那就给类定义为<code>final</code>吧</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Turn <span class="built_in">any</span> <span class="keyword">generic</span> <span class="keyword">type</span> into a reference <span class="keyword">type</span> using this Box <span class="keyword">class</span>.</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> Box&lt;T&gt; &#123;</span><br><span class="line">  let <span class="keyword">value</span>: T</span><br><span class="line">  init(_ <span class="keyword">value</span>: T) &#123;</span><br><span class="line">    self.<span class="keyword">value</span> = <span class="keyword">value</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数定义"><a href="#函数定义" class="headerlink" title="函数定义"></a>函数定义</h2><p>函数定义在一行可以定义完包括大括号</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reticulateSplines</span><span class="params">(spline: [Double])</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">  <span class="comment">// reticulate code goes here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>多个参数，让每个参数应该在新的一行</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reticulateSplines</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  spline: [Double], </span></span></span><br><span class="line"><span class="function"><span class="params">  adjustmentFactor: Double,</span></span></span><br><span class="line"><span class="function"><span class="params">  translateConstant: Int, comment: String</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">  <span class="comment">// reticulate code goes here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Void表示缺省</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateConstraints</span><span class="params">()</span></span> -&gt; <span class="type">Void</span> &#123;</span><br><span class="line">  <span class="comment">// magic happens here</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typealias</span> <span class="type">CompletionHandler</span> = (result) -&gt; <span class="type">Void</span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateConstraints</span><span class="params">()</span> -&gt; <span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// magic happens here</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">typealias CompletionHandler = (result) -&gt; ()</span><br></pre></td></tr></table></figure>
<h2 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h2><p>Mirror the style of function declarations at call sites. Calls that fit on a single line should be written as such:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> success = reticulateSplines(splines)</span><br></pre></td></tr></table></figure>
<p>If the call site must be wrapped, put each parameter on a new line, indented one additional level:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> success = reticulateSplines(</span><br><span class="line">  spline: splines,</span><br><span class="line">  adjustmentFactor: <span class="number">1.3</span>,</span><br><span class="line">  translateConstant: <span class="number">2</span>,</span><br><span class="line">  comment: <span class="string">"normalize the display"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="闭包表达式"><a href="#闭包表达式" class="headerlink" title="闭包表达式"></a>闭包表达式</h2><p>只有参数列表末尾有一个闭包表达式参数时，才使用尾随闭包。否则还是应该加上参数名字</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">UIView.animate(withDuration:</span> <span class="number">1.0</span><span class="string">)</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">self.myView.alpha</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">UIView.animate(withDuration:</span> <span class="number">1.0</span><span class="string">,</span> <span class="attr">animations:</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">self.myView.alpha</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">&#125;,</span> <span class="attr">completion:</span> <span class="string">&#123;</span> <span class="string">finished</span> <span class="string">in</span></span><br><span class="line">  <span class="string">self.myView.removeFromSuperview()</span></span><br><span class="line"><span class="string">&#125;)</span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">UIView.animate(withDuration:</span> <span class="number">1.0</span><span class="string">,</span> <span class="attr">animations:</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">self.myView.alpha</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="string">UIView.animate(withDuration:</span> <span class="number">1.0</span><span class="string">,</span> <span class="attr">animations:</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">self.myView.alpha</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">&#125;)</span> <span class="string">&#123;</span> <span class="string">f</span> <span class="string">in</span></span><br><span class="line">  <span class="string">self.myView.removeFromSuperview()</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>对于上下文清晰的单个参数表达式时，使用隐式返回:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">attendeeList.<span class="built_in">sort</span> &#123; a, b <span class="keyword">in</span></span><br><span class="line">  a &gt; b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用尾随闭包的链式方法上下文应该是易读的。而间隔换行、参数等由作者自觉定义：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">value</span> = numbers.<span class="keyword">map</span> &#123; <span class="variable">$0</span> * <span class="number">2</span> &#125;<span class="built_in">.filter</span> &#123; <span class="variable">$0</span> % <span class="number">3</span> == <span class="number">0</span> &#125;.index(of: <span class="number">90</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">value</span> = numbers</span><br><span class="line">  .<span class="keyword">map</span> &#123;<span class="variable">$0</span> * <span class="number">2</span>&#125;</span><br><span class="line">  <span class="built_in">.filter</span> &#123;<span class="variable">$0</span> &gt; <span class="number">50</span>&#125;</span><br><span class="line">  .<span class="keyword">map</span> &#123;<span class="variable">$0</span> + <span class="number">10</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h2><p>尽量使用<code>Swfit</code>的原生类型表达式</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> width = <span class="number">120.0</span>                                    <span class="comment">// Double</span></span><br><span class="line"><span class="keyword">let</span> widthString = <span class="string">"\(width)"</span>                         <span class="comment">// String</span></span><br></pre></td></tr></table></figure>
<p><strong>Less Preferred</strong>:</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> width = <span class="number">120.0</span>                                    <span class="comment">// Double</span></span><br><span class="line"><span class="keyword">let</span> widthString = (width <span class="keyword">as</span> NSNumber).stringValue    <span class="comment">// String</span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let <span class="built_in">width</span>: NSNumber = <span class="number">120.0</span>                          <span class="comment">// NSNumber</span></span><br><span class="line">let widthString: NSString = <span class="built_in">width</span>.stringValue        <span class="comment">// NSString</span></span><br></pre></td></tr></table></figure>
<p>在使用<code>CG</code>开头的相关类型，使用<code>CGFloat</code>会使代码更加清晰易读</p>
<h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><p>常量可以应该用<code>let</code>关键字定义</p>
<p><strong>Tip:</strong> 最好是全部都使用<code>let</code>，只有要编译有问题时才使用<code>var</code></p>
<p>定义类常量比实例常量会更好。定义类常量使用<code>static let</code>关键字。</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Math</span> &#123;</span></span><br><span class="line">  static let e = <span class="number">2.718281828459045235360287</span></span><br><span class="line">  static let root2 = <span class="number">1.41421356237309504880168872</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let hypotenuse = side * Math.root2</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">e</span> = <span class="number">2.718281828459045235360287</span>  // pollutes global namespace</span><br><span class="line"><span class="keyword">let</span> <span class="attr">root2</span> = <span class="number">1.41421356237309504880168872</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">hypotenuse</span> = side * root2 // what is root2?</span><br></pre></td></tr></table></figure>
<h3 id="Optionals-可选类型"><a href="#Optionals-可选类型" class="headerlink" title="Optionals 可选类型"></a>Optionals 可选类型</h3><p>如果定义变量和函数返回值有可能为<code>nil</code>，应该定义为可选值<code>?</code></p>
<p>使用<code>!</code>定义强制解包类型，只有在你接下来会明确该变量被会初始化。例如：将会在<code>viewDidLoad()</code>方法实例的子view。</p>
<p>访问可选类型时，如果有多个类型或者只访问一次，可以使用语法链</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">textContainer</span>?<span class="selector-class">.textLabel</span>?<span class="selector-class">.setNeedsDisplay</span>()</span><br></pre></td></tr></table></figure>
<p>多处使用应该使用一次性绑定</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> textContainer = textContainer &#123;</span><br><span class="line">  // <span class="built_in">do</span> many things <span class="built_in">with</span> textContainer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是否可以类型不应该出现在命名中，例如：<code>optionalString</code>、<code>maybeView</code>、<code>unwrappedView</code>,因为这些信息已经包含在类型声明中</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> subview: <span class="type">UIView?</span></span><br><span class="line"><span class="keyword">var</span> volume: <span class="type">Double?</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// later on...</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> subview = subview, <span class="keyword">let</span> volume = volume &#123;</span><br><span class="line">  <span class="comment">// do something with unwrapped subview and volume</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// another example</span></span><br><span class="line"><span class="type">UIView</span>.animate(withDuration: <span class="number">2.0</span>) &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">  <span class="keyword">self</span>.alpha = <span class="number">1.0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> optionalSubview: <span class="type">UIView?</span></span><br><span class="line"><span class="keyword">var</span> volume: <span class="type">Double?</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> unwrappedSubview = optionalSubview &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> realVolume = volume &#123;</span><br><span class="line">    <span class="comment">// do something with unwrappedSubview and realVolume</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// another example</span></span><br><span class="line"><span class="type">UIView</span>.animate(withDuration: <span class="number">2.0</span>) &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> strongSelf = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">  strongSelf.alpha = <span class="number">1.0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="类型推断"><a href="#类型推断" class="headerlink" title="类型推断"></a>类型推断</h3><p>让编译器推断变量或者常量的类型，当真需要时，才会指定特定的类型，例如： <code>CGFloat</code>和 <code>Int16</code></p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">message</span> = <span class="string">"Click the button"</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">currentBounds</span> = computeViewBounds()</span><br><span class="line">var <span class="attr">names</span> = [<span class="string">"Mic"</span>, <span class="string">"Sam"</span>, <span class="string">"Christine"</span>]</span><br><span class="line"><span class="keyword">let</span> maximumWidth: <span class="attr">CGFloat</span> = <span class="number">106.5</span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let message: String = "Click the button"</span><br><span class="line">let currentBounds: CGRect = computeViewBounds()</span><br><span class="line">var names = [<span class="string">String</span>](<span class="link"></span>)</span><br></pre></td></tr></table></figure>
<h3 id="语法糖"><a href="#语法糖" class="headerlink" title="语法糖"></a>语法糖</h3><p>尽量使用较短快捷的定义版本</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> deviceModels: [<span class="built_in">String</span>]</span><br><span class="line"><span class="keyword">var</span> employees: [Int: <span class="built_in">String</span>]</span><br><span class="line"><span class="keyword">var</span> faxNumber: Int?</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> deviceModels: <span class="type">Array</span>&lt;<span class="keyword">String</span>&gt;</span><br><span class="line"><span class="keyword">var</span> employees: <span class="type">Dictionary</span>&lt;<span class="keyword">Int</span>, <span class="keyword">String</span>&gt;</span><br><span class="line"><span class="keyword">var</span> faxNumber: <span class="type">Optional</span>&lt;<span class="keyword">Int</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><p>代码无论在什么时候都不应该产生循环引用，使用<code>weak</code>和<code>unowned</code>引用防止产生循环引用，或者使用值类型。</p>
<h3 id="延长对象寿命"><a href="#延长对象寿命" class="headerlink" title="延长对象寿命"></a>延长对象寿命</h3><p>延长对象寿命使用<code>[weak self]</code> 和 <code>guard let = self else { return }</code> 语法。</p>
<p><strong>Preferred</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">resource.request().onComplete &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] response <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> model = <span class="keyword">self</span>.updateModel(response)</span><br><span class="line">  <span class="keyword">self</span>.updateUI(model)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// might crash if self is released before response returns</span></span><br><span class="line">resource.request().onComplete &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] response <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">let</span> model = <span class="keyword">self</span>.updateModel(response)</span><br><span class="line">  <span class="keyword">self</span>.updateUI(model)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// deallocate could happen between updating the model and updating UI</span></span><br><span class="line">resource.request().onComplete &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] response <span class="keyword">in</span></span><br><span class="line">  <span class="keyword">let</span> model = <span class="keyword">self</span>?.updateModel(response)</span><br><span class="line">  <span class="keyword">self</span>?.updateUI(model)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="控制流"><a href="#控制流" class="headerlink" title="控制流"></a>控制流</h2><p>Prefer the <code>for-in</code> style of <code>for</code> loop over the <code>while-condition-increment</code> style.</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">3</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"Hello three times"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (index, person) <span class="keyword">in</span> attendeeList.enumerated() &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"\(person) is at position #\(index)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">stride</span>(from: <span class="number">0</span>, to: items.<span class="built_in">count</span>, by: <span class="number">2</span>) &#123;</span><br><span class="line">  <span class="built_in">print</span>(index)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> (<span class="number">0</span>...<span class="number">3</span>).reversed() &#123;</span><br><span class="line">  <span class="built_in">print</span>(index)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="number">3</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"Hello three times"</span>)</span><br><span class="line">  i += <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; attendeeList.<span class="built_in">count</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> person = attendeeList[i]</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"\(person) is at position #\(i)"</span>)</span><br><span class="line">  i += <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三元表达式"><a href="#三元表达式" class="headerlink" title="三元表达式"></a>三元表达式</h3><p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> value = <span class="number">5</span></span><br><span class="line">result = value != <span class="number">0</span> ? x : y</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> isHorizontal = <span class="literal">true</span></span><br><span class="line">result = isHorizontal ? x : y</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = a &gt; b ? x = <span class="built_in">c</span> &gt; d ? <span class="built_in">c</span> : d : y</span><br></pre></td></tr></table></figure>
<h2 id="黄金路径"><a href="#黄金路径" class="headerlink" title="黄金路径"></a>黄金路径</h2><p>当使用条件编写代码时，应该及时<code>return</code>。也就是说，不要嵌套<code>if</code>语句，关键字<code>guard</code>你值得了解</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">computeFFT</span><span class="params">(context: Context?, inputData: InputData?)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Frequencies</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> context = context <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="type">FFTError</span>.noContext</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> inputData = inputData <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="type">FFTError</span>.noInputData</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// use context and input to compute the frequencies</span></span><br><span class="line">  <span class="keyword">return</span> frequencies</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">computeFFT</span><span class="params">(context: Context?, inputData: InputData?)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Frequencies</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> context = context &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> inputData = inputData &#123;</span><br><span class="line">      <span class="comment">// use context and input to compute the frequencies</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> frequencies</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="type">FFTError</span>.noInputData</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="type">FFTError</span>.noContext</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是多个条件的情况下，使用<code>guard</code>更加清晰明了。例子：</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">guard</span> </span><br><span class="line">  <span class="keyword">let</span> number1 = number1,</span><br><span class="line">  <span class="keyword">let</span> number2 = number2,</span><br><span class="line">  <span class="keyword">let</span> number3 = number3 </span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"impossible"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// do something with numbers</span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> number1 = number1 &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> number2 = number2 &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> number3 = number3 &#123;</span><br><span class="line">      <span class="comment">// do something with numbers</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">fatalError</span>(<span class="string">"impossible"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">"impossible"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">fatalError</span>(<span class="string">"impossible"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分号"><a href="#分号" class="headerlink" title="分号"></a>分号</h2><p>Swift 不要求在每句语句后面加分号，只要在多句语句在同一行的时才需要分号</p>
<p>不要把多行语句在同一行用分号隔开来</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> swift = <span class="string">"not a scripting language"</span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> swift = <span class="string">"not a scripting language"</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="括号"><a href="#括号" class="headerlink" title="括号"></a>括号</h2><p>在条件语句中括号不是一定要的，应该省略掉。</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> name == <span class="string">"Hello"</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"World"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (name == <span class="string">"Hello"</span>) &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"World"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很长的表达式中，使用括号可以使代码更加清晰</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> playerMark = (player == current ? <span class="string">"X"</span> : <span class="string">"O"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="多行字符串"><a href="#多行字符串" class="headerlink" title="多行字符串"></a>多行字符串</h2><p>当创建很长字符串时，应该使用多行字符串语法</p>
<p><strong>Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> message = <span class="string">"""</span></span><br><span class="line"><span class="string">  You cannot charge the flux \</span></span><br><span class="line"><span class="string">  capacitor with a 9V battery.</span></span><br><span class="line"><span class="string">  You must use a super-charger \</span></span><br><span class="line"><span class="string">  which costs 10 credits. You currently \</span></span><br><span class="line"><span class="string">  have \(credits) credits available.</span></span><br><span class="line"><span class="string">  """</span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> message = <span class="string">"""You cannot charge the flux \</span></span><br><span class="line"><span class="string">  capacitor with a 9V battery.</span></span><br><span class="line"><span class="string">  You must use a super-charger \</span></span><br><span class="line"><span class="string">  which costs 10 credits. You currently \</span></span><br><span class="line"><span class="string">  have \(credits) credits available.</span></span><br><span class="line"><span class="string">  """</span></span><br></pre></td></tr></table></figure>
<p><strong>Not Preferred</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> message = <span class="string">"You cannot charge the flux "</span> +</span><br><span class="line">  <span class="string">"capacitor with a 9V battery.\n"</span> +</span><br><span class="line">  <span class="string">"You must use a super-charger "</span> +</span><br><span class="line">  <span class="string">"which costs 10 credits. You currently "</span> +</span><br><span class="line">  <span class="string">"have \(credits) credits available."</span></span><br></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://github.com/raywenderlich/swift-style-guide/blob/master/README.markdown" target="_blank" rel="noopener">The Official raywenderlich.com Swift Style Guide.
</a></li>
<li><a href="https://swift.org/documentation/api-design-guidelines/" target="_blank" rel="noopener">The Swift API Design Guidelines</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/18/ios-continuous-build-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/18/ios-continuous-build-4/" itemprop="url">iOS持续集成（四）——jenkins</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-18T10:50:01+08:00">
                2018-09-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>Jenkins</code>是开源的自动构建服务器，一般被用于各种各样的构建任务、测试和发布软件等等。因为是图形化界面，所以对于一些黑盒测试人员来说，非常友好。<code>Jenkins</code>+<code>Fastlane</code>简直就是我们客户端的福音。</p>
<h3 id="安装-amp-amp-配置"><a href="#安装-amp-amp-配置" class="headerlink" title="安装 &amp;&amp; 配置"></a>安装 &amp;&amp; 配置</h3><p>在 macOS 安装非常简单，可以直接到官网找到<a href="http://mirrors.jenkins.io/osx/latest" target="_blank" rel="noopener">下载包</a>，直接跟我们安装应用差不多。</p>
<p>当然还支持<code>Docker</code>、<code>brew</code>、<code>war包</code>等一些方式</p>
<p>具体可以查看<a href="https://jenkins.io/doc/book/installing/" target="_blank" rel="noopener">官网介绍</a></p>
<p>安装完成后，访问 <code>http://localhost:8080</code>就能第一次访问<code>Jenkins</code>。</p>
<p>然后会出现下面的界面：</p>
<p><img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-081750.png" alt></p>
<p>在此过程中文件夹<code>secrets</code>由于没有访问权限。那只能手动改文件夹的权限，从里复制密码填进去。</p>
<p>接下面会要求安装推荐插件，或者自定义安装。我们这可以点击推荐安装。</p>
<p>第一个账户：</p>
<p><img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-082916.png" alt></p>
<h3 id="第一个项目"><a href="#第一个项目" class="headerlink" title="第一个项目"></a>第一个项目</h3><p>点击左边的 <strong><code>新建任务</code></strong></p>
<p><img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-083830.png" alt></p>
<p>选择 <strong><code>构建一个自由风格的软件项目</code></strong>，输入项目名字</p>
<p><img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-084508.png" alt></p>
<p>由于我们用的是<code>Git</code>管理代码，所以配置一个<code>ssh key</code></p>
<p><img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-084709.png" alt></p>
<p>由于项目里面多个分支，为了可以选择分支构建。</p>
<p>另外，为了区别<code>Fir</code>和<code>TestFlight</code>两个渠道</p>
<p>我们添加两个参数：</p>
<p><img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-090839.png" alt></p>
<p> 这里的<code>Git Parameter</code>需要手动到插件管理上装好</p>
<p> 然后在下面的 <code>Git</code>选项中使用<code>branch</code>变量</p>
<p> <img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-091401.png" alt></p>
<p> 由于使用的是<code>Fastlane</code>构建，那么在构建选项上，选择<code>执行shell</code></p>
<p> <img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-092734.png" alt></p>
<p> 这样子就算完成的一个简单项目的配置</p>
<h3 id="Jenkins-节点-分布式构建"><a href="#Jenkins-节点-分布式构建" class="headerlink" title="Jenkins 节点(分布式构建)"></a>Jenkins 节点(分布式构建)</h3><p> 构建使用的电脑一般都比较古老，为了把构建的压力分担出去，可能会选多台<code>Mac</code>共同构建，这样子就形成了分布式。</p>
<h4 id="添加一个节点"><a href="#添加一个节点" class="headerlink" title="添加一个节点"></a>添加一个节点</h4><p> 点击 系统管理 -&gt; 管理节点 进入节点页面</p>
<p> <img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-100416.png" alt></p>
<p> 点击确定，配置节点</p>
<p><img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-101214.png" alt></p>
<p>然后点击节点，进去节点页面，启动即可。</p>
<p>回到首页就可以看到节点数量。</p>
<p><img src="http://pdonhhxml.bkt.clouddn.com/2018-09-10-101329.png" alt></p>
<p>这样子一个节点配置完成</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文仅仅是持续集成的入门，更多个性化的配置，需要根据不同的需求，通过<code>Jenkins</code>的插件完成。通过<code>Jenkins</code>集成可以完成的内容，还有单元测试、代码规范检查等等。</p>
<p>能偷懒，别自已动手，机器就是我们的最好帮手。写代码不是搬砖，是创造具有更多生产力的工具。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/17/ios-continuous-build-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/17/ios-continuous-build-3/" itemprop="url">iOS持续集成（三）—— fastlane 自定义插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-17T09:50:00+08:00">
                2018-09-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>fastlane</code>的强大带我们不少的便利，但事无人愿。总有些不一样的需求，今天就给大家带来的是<code>fastlane</code>的<code>action</code>和插件。</p>
<p>这也是<code>fastlane</code>精髓部分，它使<code>fastlane</code>具有强大扩展性，以保证变化不断的个性化需求。</p>
<h3 id="自定义本地action"><a href="#自定义本地action" class="headerlink" title="自定义本地action"></a>自定义本地<code>action</code></h3><p>在项目中，可以创建自定义的<code>action</code>扩展<code>fastlane</code>的功能性。创建的这个<code>action</code>跟<code>fastlane</code>内置的<code>action</code>在使用上面来说没多大区别。下面来个例子：</p>
<h4 id="创建本地action"><a href="#创建本地action" class="headerlink" title="创建本地action"></a>创建本地<code>action</code></h4><p>更新 build 版本号，格式就以年月日时分。在终端输入下面命令：</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane <span class="keyword">new</span><span class="number">_</span>action</span><br></pre></td></tr></table></figure>
<h4 id="action实现分析"><a href="#action实现分析" class="headerlink" title="action实现分析"></a><code>action</code>实现分析</h4><p>在后面会被要求输入<code>action</code>的名字，输入<code>update_build_version</code>按回车后，<code>fastlane</code>会在<code>fastlane/actions</code>目录下面创建后缀为<code>.ruby</code>文件。请看下面的文件内容</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Fastlane</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Actions</span></span></span><br><span class="line">    <span class="class"><span class="keyword">module</span> <span class="title">SharedValues</span></span></span><br><span class="line">      UPDATE_BUILD_VERSION = <span class="symbol">:UPDATE_BUILD_VERSION_CUSTOM_VALUE</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">UpdateBuildVersionAction</span> &lt; Action</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">run</span><span class="params">(params)</span></span> <span class="comment"># 这个方法为Action的主方法，在这里咱们写入更新版本号的内容</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> params[<span class="symbol">:version_number</span>]</span><br><span class="line">          new_version = params[<span class="symbol">:version_number</span>]</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">          <span class="comment"># 格式化时间</span></span><br><span class="line">          new_version = Time.now.strftime(<span class="string">"%Y%M%d"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        command = <span class="string">"agvtool new-vresion -all <span class="subst">#&#123;new_version&#125;</span>"</span> <span class="comment">#使用苹果的 agvtool 工具更新版本号 </span></span><br><span class="line"></span><br><span class="line">        Actions.sh(command) <span class="comment">#执行上面的 shell 命令</span></span><br><span class="line">        Actions.lane_context[SharedValues::UPDATE_BUILD_VERSION] = new_version <span class="comment"># 更新全局变量，供其他的Actions使用</span></span><br><span class="line">        </span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">description</span>  <span class="comment"># 对于该Action小于80字符的简短描述</span></span></span><br><span class="line">        <span class="string">"A short description with &lt;= 80 characters of what this action does"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">details</span> <span class="comment"># 对于该Action的详细描述</span></span></span><br><span class="line">        <span class="comment"># Optional: 可选</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">available_options</span> <span class="comment"># 定义外部输入的参数，在这里咱们定义一个指定版本号的参数</span></span></span><br><span class="line">      </span><br><span class="line">        [</span><br><span class="line">          FastlaneCore::ConfigItem.new(<span class="symbol">key:</span> <span class="symbol">:version_number</span>, <span class="comment"># run方法里面根据该key获取参数 </span></span><br><span class="line">                                       <span class="symbol">env_name:</span> <span class="string">"FL_UPDATE_BUILD_VERSION_VERSION_NUMBER"</span>, <span class="comment"># 环境变量</span></span><br><span class="line">                                       <span class="symbol">description:</span> <span class="string">"Change to a specific version"</span>, <span class="comment"># 参数简短描述</span></span><br><span class="line">                                       <span class="symbol">optional:</span> <span class="literal">true</span>),</span><br><span class="line">        ]</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">output</span> <span class="comment"># 输入值描述，如果在 run 方法更新 SharedValues 模块里面自定义的变量，供其他的 Action 使用，可选</span></span></span><br><span class="line">        [</span><br><span class="line">          [<span class="string">'UPDATE_BUILD_VERSION_CUSTOM_VALUE'</span>, <span class="string">'A description of what this value contains'</span>]</span><br><span class="line">        ]</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">return_value</span> <span class="comment"># 返回值描述, 指的 run 方法会有返回值。可选</span></span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">authors</span> <span class="comment"># 作者</span></span></span><br><span class="line">        [<span class="string">"ChenJzzz"</span>]</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">is_supported?</span><span class="params">(platform)</span></span> <span class="comment"># 支持的平台</span></span><br><span class="line">        <span class="comment"># you can do things like</span></span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        <span class="comment">#  true</span></span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        <span class="comment">#  platform == :ios</span></span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        <span class="comment">#  [:ios, :mac].include?(platform)</span></span><br><span class="line">        <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">        platform == <span class="symbol">:ios</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>从上面的方法上来看，主要的还是<code>run</code>方法和<code>available_options</code>方法。如果看不懂上面的代码，那去补一下<code>ruby</code>相关的语法。OK，这个<code>action</code>跟其他的<code>action</code>一样，在<code>Fastlane</code>直接使用就可以了。在终端输入<code>fastlane action update_build_version</code>，会像下面一样，打印出<code>action</code>的相关信息</p>
<p><img src="http://pdonhhxml.bkt.clouddn.com/1534640236740.jpg" alt="image"></p>
<p>顺便提一下要在另外的项目上使用，直接复制过去就行了。至于要提交到<code>fastlane</code>的官方库，还是相对来说门槛较高。</p>
<h3 id="自定义插件"><a href="#自定义插件" class="headerlink" title="自定义插件"></a>自定义插件</h3><p>上面的<code>action</code>在共享这方面，只能靠复制这一手段，相当之不优雅。那么插件是我们最好的选择。</p>
<p><strong>创建插件</strong></p>
<p>进入一个新的目录</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastlane <span class="keyword">new</span><span class="type">_plugin</span> [plugin_name]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>fastlane</code> 创建<code>Ruby gem</code>库目录</li>
<li><code>lib/fastlane/plugin/[plugin_name]/actions/[plugin_name].rb</code>这个文件是我们要实现的<code>action</code>文件</li>
</ul>
<p>插件跟<code>action</code>都是同样的写法。在这里就不重复描述了。</p>
<p>在当前目录下， 可以运行<code>fastlane test</code>，测试插件是否正确</p>
<h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h4><h5 id="安装已发布到RubyGems的插件"><a href="#安装已发布到RubyGems的插件" class="headerlink" title="安装已发布到RubyGems的插件"></a>安装已发布到<code>RubyGems</code>的插件</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastlane</span> add_plugin<span class="meta"> [name]</span></span><br></pre></td></tr></table></figure>
<p><code>fastlane</code>会执行以下步骤</p>
<ul>
<li>添加插件到<code>fastlane/Pluginfile</code></li>
<li>使<code>./Gemfile</code>文件正确引用<code>fastlane/Pluginfile</code></li>
<li>运行<code>fastlane install_plugins</code>安装插件以及需要的依赖</li>
<li>如果之前未安装过插件，会生成三个文件：<code>Gemfile</code>、<code>Gemfile.lock</code>和<code>fastlane/Pluginfile</code></li>
</ul>
<h5 id="安装其他插件"><a href="#安装其他插件" class="headerlink" title="安装其他插件"></a>安装其他插件</h5><p>正如上面所说，在项目里面的<code>fastlane/Pluginfile</code>添加下面内容</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 安装发布到 Github 的插件</span></span><br><span class="line">gem <span class="string">"fastlane-plugin-example"</span>, git: <span class="string">"https://github.com/fastlane/fastlane-plugin-example"</span></span><br><span class="line"><span class="meta"># 安装本地插件</span></span><br><span class="line">gem <span class="string">"fastlane-plugin-xcversion"</span>, path: <span class="string">"../fastlane-plugin-xcversion"</span></span><br></pre></td></tr></table></figure>
<p>在终端运行<code>fastlane/Pluginfile</code>(或者 <code>bundle exec fastlane/Pluginfile</code>)，安装插件以及相关依赖</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><code>action</code>的出现，大大的增强了<code>fastlane</code>的扩展性。使我们适应自己的业务，定制所需要<code>action</code>。另外，<code>Plugin</code>使<code>fastlane</code>在有强大的扩展性同量，使用更加灵活。</p>
<p>总的来说，如果是单单的项目，<code>action</code>可以解决问题。如果是多个项目，使用<code>plugins</code>是不二选择。</p>
<blockquote>
<p>小Tips：如果看不懂，去补一下Ruby的语法。还有就是多点看一下网上action和plugin写法。</p>
</blockquote>
<p>参考文档：</p>
<p><a href="!https://docs.fastlane.tools/plugins/create-plugin/">Create Your Own Plugin（官方文档）</a></p>
<p><a href="!https://docs.fastlane.tools/plugins/available-plugins/">Available Plugins</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/10/ios-continuous-build-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/ios-continuous-build-2/" itemprop="url">iOS持续集成（二）——证书管理神器match</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-10T10:12:31+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>对于iOS的开发者来说，一定都会遇到被证书与测试设备烦到不行的时候。后台的证书乱七八糟，添加设备后打包的出来的ipa总是装不上，证书无效等等问题。这些问题一搞就是浪费了大部分时间。工程师的世界里怎么能忍受这些重复而且毫无意义的工作？这不，<code>fastlane</code>里面的<code>match</code>解决上面的所有问题。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/09/10/ios-continuous-build-2/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/02/ios-continuous-build-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/02/ios-continuous-build-1/" itemprop="url">iOS持续集成（一）——fastlane 使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-02T17:56:31+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h3><p>回想一下我们发布应用，要进行多少步操作。一旦其中一步失误了，又得重新来。这完完全全不是我们工程师的风格。在软件工程里面，我们一直都推崇把重复、流程化的工作交给程序完成，像这种浪费人生的工作，实在是不应该浪费我们的人生。这次的文章主角就是为了解放我们而来—— <code>fastlane</code>。这个明星库在 <code>github</code> 已经高达 1w 多的start量。</p>
<h3 id="Fastlane"><a href="#Fastlane" class="headerlink" title="Fastlane"></a>Fastlane</h3><p>fastlane 是 iOS (还有 Android ) 布署和发布最好的一套工具。它处理了所有重复的工作，例如生成截图，处理签名和发布应用。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>fastlane实际是由Ruby写的，使用Ruby的Gem安装是我们的不二选择</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gem <span class="keyword">install</span> fastlane -NV</span><br></pre></td></tr></table></figure>
<p>接着在终端进入项目里面（目前fastlane swift 正在测试，就以之前的版本讲解）</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastlane  init</span></span><br></pre></td></tr></table></figure>
<p>按照提示初始化完成之后，在项目下面生成 fastlane 文件夹</p>
<h3 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h3><p>先普及两个重要的文件，初始化后在<code>./fastlane</code>文件件即可找到</p>
<h3 id="Appfile"><a href="#Appfile" class="headerlink" title="Appfile"></a>Appfile</h3><p>存放着 <strong>AppleID</strong> 或者 <strong>BundleID</strong> 等一些fastlane需要用到的信息。基本上我们不需要改动这个文件的内容。<br>它放到你项目下面的 <code>./fastlane</code>文件夹下面，默认生成的文件如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app_identifier <span class="string">"net.sunapps.1"</span> # The bundle identifier of your app</span><br><span class="line">apple_id <span class="string">"felix@krausefx.com"</span>  # Your Apple email address</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果账号里面有多个team，可以指定所有的team</span></span><br><span class="line"><span class="comment"># team_name "Felix Krause"</span></span><br><span class="line"><span class="comment"># team_id "Q2CBPJ58CA"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 App Store Connect 使用的team</span></span><br><span class="line"><span class="comment"># itc_team_name "Company Name"</span></span><br><span class="line"><span class="comment"># itc_team_id "18742801"</span></span><br></pre></td></tr></table></figure>
<p>更多详细的配置，可以参考一下文档<br><a href="https://docs.fastlane.tools/advanced/#appfile" target="_blank" rel="noopener">Appfile Doc</a></p>
<h3 id="FastFile"><a href="#FastFile" class="headerlink" title="FastFile"></a>FastFile</h3><p>一开始生成的<code>Fastlane</code>文件大概如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">platform :ios <span class="keyword">do</span></span><br><span class="line">  before_all <span class="keyword">do</span></span><br><span class="line">    </span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">desc</span> <span class="string">"Runs all the tests"</span></span><br><span class="line">  lane :<span class="keyword">test</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">scan</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># You can define as many lanes as you want</span></span><br><span class="line"></span><br><span class="line">  after_all <span class="keyword">do</span> |lane|</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">error</span> <span class="keyword">do</span> |lane, <span class="keyword">exception</span>|</span><br><span class="line">    <span class="comment"># slack(</span></span><br><span class="line">    <span class="comment">#   message: "Error message"</span></span><br><span class="line">    <span class="comment"># )</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>Fastfile</code>里面包含的块类型有四种：</p>
<ul>
<li><code>before_all</code> 用于执行任务之前的操作，比如使用<code>cocopods</code>更新pod库</li>
<li><code>after_all</code> 用于执行任务之后的操作，比如发送邮件，通知之前的</li>
<li><code>error</code> 用于发生错误的操作</li>
<li><code>lane</code> 定义用户的主要任务流程。例如打包<code>ipa</code>，执行测试等等</li>
</ul>
<p>如下面，来讲解一下lane的组成。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">desc <span class="string">"Push a new beta build to TestFlight"</span>   <span class="comment">//该任务的描述</span></span><br><span class="line"><span class="string">lane :</span>beta do  <span class="comment">//定义名字为 beta 的任务</span></span><br><span class="line">  build_app(<span class="string">workspace:</span> <span class="string">"expample.xcworkspace"</span>, <span class="string">scheme:</span> <span class="string">"example"</span>) <span class="comment">//构建App，又叫gym</span></span><br><span class="line">  upload_to_testflight <span class="comment">//上传到testfilght，</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>该任务的作用就是构建应用并上传到 TestFilght。下面有两个 Action</p>
<ul>
<li><code>build_app</code> 生成 ipa 文件</li>
<li><code>upload_to_testflight</code> 把 ipa 文件上传到 TestFilght</li>
</ul>
<p>在控制台进入项目所在的文件夹下面，执行下面命令</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastlane beta</span></span><br></pre></td></tr></table></figure>
<p>即可执行任务，按照上面的任务，会生成 ipa 并上传到 TestFilght。其实很简单，定义好任务，控制台执行任务即可。</p>
<h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><p>那么如何写一个我们属于自己的 lane 呢? 就以发布 ipa 到 fir 为例</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">desc <span class="string">"发布到Fir"</span></span><br><span class="line">lane <span class="symbol">:pulish_to_fir</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># 运行 pod install </span></span><br><span class="line">  cocoapods </span><br><span class="line">  <span class="comment"># 构建和打包ipa</span></span><br><span class="line">  gym(</span><br><span class="line">    <span class="symbol">clean:</span> <span class="keyword">true</span>,</span><br><span class="line">    <span class="symbol">output_directory:</span> <span class="string">'./firim'</span>,</span><br><span class="line">    <span class="symbol">scheme:</span> <span class="string">'xxxx'</span>,</span><br><span class="line">    <span class="symbol">configuration:</span> <span class="string">'Test'</span>,</span><br><span class="line">    <span class="symbol">export_options:</span> &#123;</span><br><span class="line">      <span class="symbol">method:</span> <span class="string">'development'</span>,</span><br><span class="line">      <span class="symbol">provisioningProfiles:</span> &#123;</span><br><span class="line">          <span class="string">"xxx.xxx.xxx"</span>: <span class="string">"match Development xxx.xxx.xxx"</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  <span class="comment"># 上传ipa到fir.im服务器，在fir.im获取firim_api_token</span></span><br><span class="line">  firim(<span class="symbol">firim_api_token:</span> <span class="string">"fir_token"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>下面解释一下上面的内容</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cocoapods</span></span><br></pre></td></tr></table></figure>
<p>在项目里执行 <code>pod install</code>，详细例子可见 <a href="https://docs.fastlane.tools/actions/cocoapods/#cocoapods" target="_blank" rel="noopener">Doc</a></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sh </span><span class="string">"./update_version.sh"</span></span><br></pre></td></tr></table></figure>
<p>这是由作者本地写的更新版本号的脚本</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gym</span> （又名build_app)</span><br></pre></td></tr></table></figure>
<p><code>gym</code> 是fastlane的里面一部分，它可以方便生成和签名ipa，能为开发者省下不少功夫。</p>
<p><a href="https://docs.fastlane.tools/actions/build_app/#build_app" target="_blank" rel="noopener">Doc</a></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">firim</span></span><br></pre></td></tr></table></figure>
<p><code>firim</code> 是一个插件，执行 <code>fastlane add_plugin firim</code> 即可把插件装好</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>fastlane里面内置很多常用的Action，具体的使用方法建议多看一下官方文档。</p>
<p>fastlane项目里面也有很多其他公司的 <a href="https://github.com/fastlane/examples" target="_blank" rel="noopener">例子</a>，在不清楚怎么使用的时候，看看这些例子也未尝不是一种方法。 </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/22/2017and2018/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/22/2017and2018/" itemprop="url">2017与2018</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-22T11:12:23+08:00">
                2018-02-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>   春节过后第一天上班，外面的天气跟我的心情一样黑暗。昨晚带着不舒服的老婆开车上来深圳,今晚我还要回到茂名喝喜酒，把怀孕的老婆一个人放在深圳两天，总有点不放心。</p>
<p>   去年一年，完成了结婚这件重要的事，在这件事了花了我不少心思，同时把我的积蓄也花光了。这都不重要，在今年的1月份老婆怀孕了，听到这个消息喜乐参半，喜的是老婆怀上BB了，忧的是这BB来得有点快，打乱我的计划。</p>
<p>   2017年，迷糊的一年。<br>   2018,给自己定个目标。</p>
<ul>
<li>锻炼身体，为了能照顾好老婆与孩子</li>
<li>搞点副业，增加收入</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/11/Some-About-dylib-of-Apple/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ChenJz">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CJZ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/11/Some-About-dylib-of-Apple/" itemprop="url">Some About dylib of Apple</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-11T11:26:34+08:00">
                2017-02-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Apple-Soure/" itemprop="url" rel="index">
                    <span itemprop="name">Apple Soure</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>dyld 是 the dynamic link editor 的缩写，它是苹果的动态链接器。</p>
<p><a href="http://blog.sunnyxx.com/2014/08/30/objc-pre-main/" target="_blank" rel="noopener">iOS 程序 main 函数之前发生了什么</a></p>
<p><a href="https://github.com/opensource-apple/dyld" target="_blank" rel="noopener">dyld in Github</a></p>
<p><a href="http://www.cocoachina.com/ios/20160516/16273.html" target="_blank" rel="noopener">你真的了解load方法么？</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ChenJz</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ChenJz</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
